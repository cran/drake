<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>How to organize your files</title>

<script type="text/javascript">
window.onload = function() {
  var imgs = document.getElementsByTagName('img'), i, img;
  for (i = 0; i < imgs.length; i++) {
    img = imgs[i];
    // center an image if it is the only element of its parent
    if (img.parentElement.childElementCount === 1)
      img.parentElement.style.textAlign = 'center';
  }
};
</script>

<!-- Styles for R syntax highlighter -->
<style type="text/css">
   pre .operator,
   pre .paren {
     color: rgb(104, 118, 135)
   }

   pre .literal {
     color: #990073
   }

   pre .number {
     color: #099;
   }

   pre .comment {
     color: #998;
     font-style: italic
   }

   pre .keyword {
     color: #900;
     font-weight: bold
   }

   pre .identifier {
     color: rgb(0, 0, 0);
   }

   pre .string {
     color: #d14;
   }
</style>

<!-- R syntax highlighter -->
<script type="text/javascript">
var hljs=new function(){function m(p){return p.replace(/&/gm,"&amp;").replace(/</gm,"&lt;")}function f(r,q,p){return RegExp(q,"m"+(r.cI?"i":"")+(p?"g":""))}function b(r){for(var p=0;p<r.childNodes.length;p++){var q=r.childNodes[p];if(q.nodeName=="CODE"){return q}if(!(q.nodeType==3&&q.nodeValue.match(/\s+/))){break}}}function h(t,s){var p="";for(var r=0;r<t.childNodes.length;r++){if(t.childNodes[r].nodeType==3){var q=t.childNodes[r].nodeValue;if(s){q=q.replace(/\n/g,"")}p+=q}else{if(t.childNodes[r].nodeName=="BR"){p+="\n"}else{p+=h(t.childNodes[r])}}}if(/MSIE [678]/.test(navigator.userAgent)){p=p.replace(/\r/g,"\n")}return p}function a(s){var r=s.className.split(/\s+/);r=r.concat(s.parentNode.className.split(/\s+/));for(var q=0;q<r.length;q++){var p=r[q].replace(/^language-/,"");if(e[p]){return p}}}function c(q){var p=[];(function(s,t){for(var r=0;r<s.childNodes.length;r++){if(s.childNodes[r].nodeType==3){t+=s.childNodes[r].nodeValue.length}else{if(s.childNodes[r].nodeName=="BR"){t+=1}else{if(s.childNodes[r].nodeType==1){p.push({event:"start",offset:t,node:s.childNodes[r]});t=arguments.callee(s.childNodes[r],t);p.push({event:"stop",offset:t,node:s.childNodes[r]})}}}}return t})(q,0);return p}function k(y,w,x){var q=0;var z="";var s=[];function u(){if(y.length&&w.length){if(y[0].offset!=w[0].offset){return(y[0].offset<w[0].offset)?y:w}else{return w[0].event=="start"?y:w}}else{return y.length?y:w}}function t(D){var A="<"+D.nodeName.toLowerCase();for(var B=0;B<D.attributes.length;B++){var C=D.attributes[B];A+=" "+C.nodeName.toLowerCase();if(C.value!==undefined&&C.value!==false&&C.value!==null){A+='="'+m(C.value)+'"'}}return A+">"}while(y.length||w.length){var v=u().splice(0,1)[0];z+=m(x.substr(q,v.offset-q));q=v.offset;if(v.event=="start"){z+=t(v.node);s.push(v.node)}else{if(v.event=="stop"){var p,r=s.length;do{r--;p=s[r];z+=("</"+p.nodeName.toLowerCase()+">")}while(p!=v.node);s.splice(r,1);while(r<s.length){z+=t(s[r]);r++}}}}return z+m(x.substr(q))}function j(){function q(x,y,v){if(x.compiled){return}var u;var s=[];if(x.k){x.lR=f(y,x.l||hljs.IR,true);for(var w in x.k){if(!x.k.hasOwnProperty(w)){continue}if(x.k[w] instanceof Object){u=x.k[w]}else{u=x.k;w="keyword"}for(var r in u){if(!u.hasOwnProperty(r)){continue}x.k[r]=[w,u[r]];s.push(r)}}}if(!v){if(x.bWK){x.b="\\b("+s.join("|")+")\\s"}x.bR=f(y,x.b?x.b:"\\B|\\b");if(!x.e&&!x.eW){x.e="\\B|\\b"}if(x.e){x.eR=f(y,x.e)}}if(x.i){x.iR=f(y,x.i)}if(x.r===undefined){x.r=1}if(!x.c){x.c=[]}x.compiled=true;for(var t=0;t<x.c.length;t++){if(x.c[t]=="self"){x.c[t]=x}q(x.c[t],y,false)}if(x.starts){q(x.starts,y,false)}}for(var p in e){if(!e.hasOwnProperty(p)){continue}q(e[p].dM,e[p],true)}}function d(B,C){if(!j.called){j();j.called=true}function q(r,M){for(var L=0;L<M.c.length;L++){if((M.c[L].bR.exec(r)||[null])[0]==r){return M.c[L]}}}function v(L,r){if(D[L].e&&D[L].eR.test(r)){return 1}if(D[L].eW){var M=v(L-1,r);return M?M+1:0}return 0}function w(r,L){return L.i&&L.iR.test(r)}function K(N,O){var M=[];for(var L=0;L<N.c.length;L++){M.push(N.c[L].b)}var r=D.length-1;do{if(D[r].e){M.push(D[r].e)}r--}while(D[r+1].eW);if(N.i){M.push(N.i)}return f(O,M.join("|"),true)}function p(M,L){var N=D[D.length-1];if(!N.t){N.t=K(N,E)}N.t.lastIndex=L;var r=N.t.exec(M);return r?[M.substr(L,r.index-L),r[0],false]:[M.substr(L),"",true]}function z(N,r){var L=E.cI?r[0].toLowerCase():r[0];var M=N.k[L];if(M&&M instanceof Array){return M}return false}function F(L,P){L=m(L);if(!P.k){return L}var r="";var O=0;P.lR.lastIndex=0;var M=P.lR.exec(L);while(M){r+=L.substr(O,M.index-O);var N=z(P,M);if(N){x+=N[1];r+='<span class="'+N[0]+'">'+M[0]+"</span>"}else{r+=M[0]}O=P.lR.lastIndex;M=P.lR.exec(L)}return r+L.substr(O,L.length-O)}function J(L,M){if(M.sL&&e[M.sL]){var r=d(M.sL,L);x+=r.keyword_count;return r.value}else{return F(L,M)}}function I(M,r){var L=M.cN?'<span class="'+M.cN+'">':"";if(M.rB){y+=L;M.buffer=""}else{if(M.eB){y+=m(r)+L;M.buffer=""}else{y+=L;M.buffer=r}}D.push(M);A+=M.r}function G(N,M,Q){var R=D[D.length-1];if(Q){y+=J(R.buffer+N,R);return false}var P=q(M,R);if(P){y+=J(R.buffer+N,R);I(P,M);return P.rB}var L=v(D.length-1,M);if(L){var O=R.cN?"</span>":"";if(R.rE){y+=J(R.buffer+N,R)+O}else{if(R.eE){y+=J(R.buffer+N,R)+O+m(M)}else{y+=J(R.buffer+N+M,R)+O}}while(L>1){O=D[D.length-2].cN?"</span>":"";y+=O;L--;D.length--}var r=D[D.length-1];D.length--;D[D.length-1].buffer="";if(r.starts){I(r.starts,"")}return R.rE}if(w(M,R)){throw"Illegal"}}var E=e[B];var D=[E.dM];var A=0;var x=0;var y="";try{var s,u=0;E.dM.buffer="";do{s=p(C,u);var t=G(s[0],s[1],s[2]);u+=s[0].length;if(!t){u+=s[1].length}}while(!s[2]);if(D.length>1){throw"Illegal"}return{r:A,keyword_count:x,value:y}}catch(H){if(H=="Illegal"){return{r:0,keyword_count:0,value:m(C)}}else{throw H}}}function g(t){var p={keyword_count:0,r:0,value:m(t)};var r=p;for(var q in e){if(!e.hasOwnProperty(q)){continue}var s=d(q,t);s.language=q;if(s.keyword_count+s.r>r.keyword_count+r.r){r=s}if(s.keyword_count+s.r>p.keyword_count+p.r){r=p;p=s}}if(r.language){p.second_best=r}return p}function i(r,q,p){if(q){r=r.replace(/^((<[^>]+>|\t)+)/gm,function(t,w,v,u){return w.replace(/\t/g,q)})}if(p){r=r.replace(/\n/g,"<br>")}return r}function n(t,w,r){var x=h(t,r);var v=a(t);var y,s;if(v){y=d(v,x)}else{return}var q=c(t);if(q.length){s=document.createElement("pre");s.innerHTML=y.value;y.value=k(q,c(s),x)}y.value=i(y.value,w,r);var u=t.className;if(!u.match("(\\s|^)(language-)?"+v+"(\\s|$)")){u=u?(u+" "+v):v}if(/MSIE [678]/.test(navigator.userAgent)&&t.tagName=="CODE"&&t.parentNode.tagName=="PRE"){s=t.parentNode;var p=document.createElement("div");p.innerHTML="<pre><code>"+y.value+"</code></pre>";t=p.firstChild.firstChild;p.firstChild.cN=s.cN;s.parentNode.replaceChild(p.firstChild,s)}else{t.innerHTML=y.value}t.className=u;t.result={language:v,kw:y.keyword_count,re:y.r};if(y.second_best){t.second_best={language:y.second_best.language,kw:y.second_best.keyword_count,re:y.second_best.r}}}function o(){if(o.called){return}o.called=true;var r=document.getElementsByTagName("pre");for(var p=0;p<r.length;p++){var q=b(r[p]);if(q){n(q,hljs.tabReplace)}}}function l(){if(window.addEventListener){window.addEventListener("DOMContentLoaded",o,false);window.addEventListener("load",o,false)}else{if(window.attachEvent){window.attachEvent("onload",o)}else{window.onload=o}}}var e={};this.LANGUAGES=e;this.highlight=d;this.highlightAuto=g;this.fixMarkup=i;this.highlightBlock=n;this.initHighlighting=o;this.initHighlightingOnLoad=l;this.IR="[a-zA-Z][a-zA-Z0-9_]*";this.UIR="[a-zA-Z_][a-zA-Z0-9_]*";this.NR="\\b\\d+(\\.\\d+)?";this.CNR="\\b(0[xX][a-fA-F0-9]+|(\\d+(\\.\\d*)?|\\.\\d+)([eE][-+]?\\d+)?)";this.BNR="\\b(0b[01]+)";this.RSR="!|!=|!==|%|%=|&|&&|&=|\\*|\\*=|\\+|\\+=|,|\\.|-|-=|/|/=|:|;|<|<<|<<=|<=|=|==|===|>|>=|>>|>>=|>>>|>>>=|\\?|\\[|\\{|\\(|\\^|\\^=|\\||\\|=|\\|\\||~";this.ER="(?![\\s\\S])";this.BE={b:"\\\\.",r:0};this.ASM={cN:"string",b:"'",e:"'",i:"\\n",c:[this.BE],r:0};this.QSM={cN:"string",b:'"',e:'"',i:"\\n",c:[this.BE],r:0};this.CLCM={cN:"comment",b:"//",e:"$"};this.CBLCLM={cN:"comment",b:"/\\*",e:"\\*/"};this.HCM={cN:"comment",b:"#",e:"$"};this.NM={cN:"number",b:this.NR,r:0};this.CNM={cN:"number",b:this.CNR,r:0};this.BNM={cN:"number",b:this.BNR,r:0};this.inherit=function(r,s){var p={};for(var q in r){p[q]=r[q]}if(s){for(var q in s){p[q]=s[q]}}return p}}();hljs.LANGUAGES.cpp=function(){var a={keyword:{"false":1,"int":1,"float":1,"while":1,"private":1,"char":1,"catch":1,"export":1,virtual:1,operator:2,sizeof:2,dynamic_cast:2,typedef:2,const_cast:2,"const":1,struct:1,"for":1,static_cast:2,union:1,namespace:1,unsigned:1,"long":1,"throw":1,"volatile":2,"static":1,"protected":1,bool:1,template:1,mutable:1,"if":1,"public":1,friend:2,"do":1,"return":1,"goto":1,auto:1,"void":2,"enum":1,"else":1,"break":1,"new":1,extern:1,using:1,"true":1,"class":1,asm:1,"case":1,typeid:1,"short":1,reinterpret_cast:2,"default":1,"double":1,register:1,explicit:1,signed:1,typename:1,"try":1,"this":1,"switch":1,"continue":1,wchar_t:1,inline:1,"delete":1,alignof:1,char16_t:1,char32_t:1,constexpr:1,decltype:1,noexcept:1,nullptr:1,static_assert:1,thread_local:1,restrict:1,_Bool:1,complex:1},built_in:{std:1,string:1,cin:1,cout:1,cerr:1,clog:1,stringstream:1,istringstream:1,ostringstream:1,auto_ptr:1,deque:1,list:1,queue:1,stack:1,vector:1,map:1,set:1,bitset:1,multiset:1,multimap:1,unordered_set:1,unordered_map:1,unordered_multiset:1,unordered_multimap:1,array:1,shared_ptr:1}};return{dM:{k:a,i:"</",c:[hljs.CLCM,hljs.CBLCLM,hljs.QSM,{cN:"string",b:"'\\\\?.",e:"'",i:"."},{cN:"number",b:"\\b(\\d+(\\.\\d*)?|\\.\\d+)(u|U|l|L|ul|UL|f|F)"},hljs.CNM,{cN:"preprocessor",b:"#",e:"$"},{cN:"stl_container",b:"\\b(deque|list|queue|stack|vector|map|set|bitset|multiset|multimap|unordered_map|unordered_set|unordered_multiset|unordered_multimap|array)\\s*<",e:">",k:a,r:10,c:["self"]}]}}}();hljs.LANGUAGES.r={dM:{c:[hljs.HCM,{cN:"number",b:"\\b0[xX][0-9a-fA-F]+[Li]?\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\b\\d+(?:[eE][+\\-]?\\d*)?L\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\b\\d+\\.(?!\\d)(?:i\\b)?",e:hljs.IMMEDIATE_RE,r:1},{cN:"number",b:"\\b\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d*)?i?\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\.\\d+(?:[eE][+\\-]?\\d*)?i?\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"keyword",b:"(?:tryCatch|library|setGeneric|setGroupGeneric)\\b",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\.\\.\\.",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\.\\.\\d+(?![\\w.])",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\b(?:function)",e:hljs.IMMEDIATE_RE,r:2},{cN:"keyword",b:"(?:if|in|break|next|repeat|else|for|return|switch|while|try|stop|warning|require|attach|detach|source|setMethod|setClass)\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"literal",b:"(?:NA|NA_integer_|NA_real_|NA_character_|NA_complex_)\\b",e:hljs.IMMEDIATE_RE,r:10},{cN:"literal",b:"(?:NULL|TRUE|FALSE|T|F|Inf|NaN)\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"identifier",b:"[a-zA-Z.][a-zA-Z0-9._]*\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"<\\-(?!\\s*\\d)",e:hljs.IMMEDIATE_RE,r:2},{cN:"operator",b:"\\->|<\\-",e:hljs.IMMEDIATE_RE,r:1},{cN:"operator",b:"%%|~",e:hljs.IMMEDIATE_RE},{cN:"operator",b:">=|<=|==|!=|\\|\\||&&|=|\\+|\\-|\\*|/|\\^|>|<|!|&|\\||\\$|:",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"%",e:"%",i:"\\n",r:1},{cN:"identifier",b:"`",e:"`",r:0},{cN:"string",b:'"',e:'"',c:[hljs.BE],r:0},{cN:"string",b:"'",e:"'",c:[hljs.BE],r:0},{cN:"paren",b:"[[({\\])}]",e:hljs.IMMEDIATE_RE,r:0}]}};
hljs.initHighlightingOnLoad();
</script>



<style type="text/css">
body, td {
   font-family: sans-serif;
   background-color: white;
   font-size: 13px;
}

body {
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 20px;
}

tt, code, pre {
   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}

h1 {
   font-size:2.2em;
}

h2 {
   font-size:1.8em;
}

h3 {
   font-size:1.4em;
}

h4 {
   font-size:1.0em;
}

h5 {
   font-size:0.9em;
}

h6 {
   font-size:0.8em;
}

a:visited {
   color: rgb(50%, 0%, 50%);
}

pre, img {
  max-width: 100%;
}
pre {
  overflow-x: auto;
}
pre code {
   display: block; padding: 0.5em;
}

code {
  font-size: 92%;
  border: 1px solid #ccc;
}

code[class] {
  background-color: #F8F8F8;
}

table, td, th {
  border: none;
}

blockquote {
   color:#666666;
   margin:0;
   padding-left: 1em;
   border-left: 0.5em #EEE solid;
}

hr {
   height: 0px;
   border-bottom: none;
   border-top-width: thin;
   border-top-style: dotted;
   border-top-color: #999999;
}

@media print {
   * {
      background: transparent !important;
      color: black !important;
      filter:none !important;
      -ms-filter: none !important;
   }

   body {
      font-size:12pt;
      max-width:100%;
   }

   a, a:visited {
      text-decoration: underline;
   }

   hr {
      visibility: hidden;
      page-break-before: always;
   }

   pre, blockquote {
      padding-right: 1em;
      page-break-inside: avoid;
   }

   tr, img {
      page-break-inside: avoid;
   }

   img {
      max-width: 100% !important;
   }

   @page :left {
      margin: 15mm 20mm 15mm 10mm;
   }

   @page :right {
      margin: 15mm 10mm 15mm 20mm;
   }

   p, h2, h3 {
      orphans: 3; widows: 3;
   }

   h2, h3 {
      page-break-after: avoid;
   }
}
</style>



</head>

<body>
<p>This vignette describes general best practices for creating, configuring, and running <code>drake</code> projects. It answers frequently asked questions and clears up common misconceptions, and it will continuously develop in response to community feedback.</p>

<h1>How to organize your files</h1>

<h2>Examples</h2>

<p>For examples of how to structure your code files, see the beginner oriented example projects:</p>

<ul>
<li><a href="https://github.com/ropensci/drake/tree/master/inst/examples/basic">basic</a></li>
<li><a href="https://github.com/ropensci/drake/tree/master/inst/examples/gsp">gsp</a></li>
<li><a href="https://github.com/ropensci/drake/tree/master/inst/examples/packages">packages</a></li>
</ul>

<p>Write the code directly with the <code>drake_example()</code> function.</p>

<pre><code class="r">drake_example(&quot;basic&quot;)
drake_example(&quot;gsp&quot;)
drake_example(&quot;packages&quot;)
</code></pre>

<p>In practice, you do not need to organize your files the way the examples do, but it does happen to be a reasonable way of doing things.</p>

<h2>Where do you put your code?</h2>

<p>It is best to write your code as a bunch of functions. You can save those functions in R scripts and then <code>source()</code> them before doing anything else.</p>

<pre><code class="r"># Load functions get_data(), analyze_data, and summarize_results()
source(&quot;my_functions.R&quot;)
</code></pre>

<p>Then, set up your workflow plan data frame.</p>

<pre><code class="r">good_plan &lt;- drake_plan(
  my_data = get_data(file_in(&quot;data.csv&quot;)), # External files need to be in commands explicitly. # nolint
  my_analysis = analyze_data(my_data),
  my_summaries = summarize_results(my_data, my_analysis)
)
## Warning: Converting double-quotes to single-quotes because the
## `strings_in_dots` argument is missing. Use the file_in(), file_out(), and
## knitr_in() functions to work with files in your commands. To remove this
## warning, either call `drake_plan()` with `strings_in_dots = &quot;literals&quot;` or
## use `pkgconfig::set_config(&quot;drake::strings_in_dots&quot; = &quot;literals&quot;)`.

good_plan
## # A tibble: 3 x 2
##   target       command                                
##   &lt;chr&gt;        &lt;chr&gt;                                  
## 1 my_data      get_data(file_in(&#39;data.csv&#39;))          
## 2 my_analysis  analyze_data(my_data)                  
## 3 my_summaries summarize_results(my_data, my_analysis)
</code></pre>

<p><code>Drake</code> knows that <code>my_analysis</code> depends on <code>my_data</code> because <code>my_data</code> is an argument to <code>analyze_data()</code>, which is part of the command for <code>my_analysis</code>.</p>

<pre><code class="r">config &lt;- drake_config(good_plan)
vis_drake_graph(config)
</code></pre>

<p><iframe
src = "https://ropensci.github.io/drake/images/good-commands.html"
width = "100%" height = "600px" allowtransparency="true"
style="border: none; box-shadow: none">
</iframe></p>

<p>Now, you can call <code>make()</code> to build the targets.</p>

<pre><code class="r">make(good_plan)
</code></pre>

<p>If your commands are really long, just put them in larger functions. <code>Drake</code> analyzes imported functions for non-file dependencies.</p>

<h2>Remember: your commands are code chunks, not R scripts</h2>

<p>Some people are accustomed to dividing their work into R scripts and then calling <code>source()</code> to run each step of the analysis. For example you might have the following files.</p>

<ul>
<li><code>get_data.R</code></li>
<li><code>analyze_data.R</code></li>
<li><code>summarize_results.R</code></li>
</ul>

<p>If you migrate to <code>drake</code>, you may be tempted to set up a workflow plan like this.</p>

<pre><code class="r">bad_plan &lt;- drake_plan(
  my_data = source(file_in(&quot;get_data.R&quot;)),
  my_analysis = source(file_in(&quot;analyze_data.R&quot;)),
  my_summaries = source(file_in(&quot;summarize_data.R&quot;))
)
## Warning: Converting double-quotes to single-quotes because the
## `strings_in_dots` argument is missing. Use the file_in(), file_out(), and
## knitr_in() functions to work with files in your commands. To remove this
## warning, either call `drake_plan()` with `strings_in_dots = &quot;literals&quot;` or
## use `pkgconfig::set_config(&quot;drake::strings_in_dots&quot; = &quot;literals&quot;)`.

bad_plan
## # A tibble: 3 x 2
##   target       command                            
##   &lt;chr&gt;        &lt;chr&gt;                              
## 1 my_data      source(file_in(&#39;get_data.R&#39;))      
## 2 my_analysis  source(file_in(&#39;analyze_data.R&#39;))  
## 3 my_summaries source(file_in(&#39;summarize_data.R&#39;))
</code></pre>

<p>But now, the dependency structure of your work is broken. Your R script files are dependencies, but since <code>my_data</code> is not mentioned in a function or command, <code>drake</code> does not know that <code>my_analysis</code> depends on it.</p>

<pre><code class="r">config &lt;- drake_config(bad_plan)
vis_drake_graph(config)
</code></pre>

<p><iframe
src = "https://ropensci.github.io/drake/images/bad-commands.html"
width = "100%" height = "600px" allowtransparency="true"
style="border: none; box-shadow: none">
</iframe></p>

<p>Dangers:</p>

<ol>
<li>In the first <code>make(bad_plan, jobs = 2)</code>, <code>drake</code> will try to build <code>my_data</code> and <code>my_analysis</code> at the same time even though <code>my_data</code> must finish before <code>my_analysis</code> begins.</li>
<li><code>Drake</code> is oblivious to <code>data.csv</code> since it is not explicitly mentioned in a workflow plan command. So when <code>data.csv</code> changes, <code>make(bad_plan)</code> will not rebuild <code>my_data</code>.</li>
<li><code>my_analysis</code> will not update when <code>my_data</code> changes.</li>
<li>The return value of <code>source()</code> is formatted counter-intuitively. If <code>source(file_in(&quot;get_data.R&quot;))</code> is the command for <code>my_data</code>, then <code>my_data</code> will always be a list with elements <code>&quot;value&quot;</code> and <code>&quot;visible&quot;</code>. In other words, <code>source(file_in(&quot;get_data.R&quot;))$value</code> is really what you would want.</li>
</ol>

<p>In addition, this <code>source()</code>-based approach is simply inconvenient. <code>Drake</code> rebuilds <code>my_data</code> every time <code>get_data.R</code> changes, even when those changes are just extra comments or blank lines. On the other hand, in the previous plan that uses <code>my_data = get_data()</code>, <code>drake</code> does not trigger rebuilds when comments or whitespace in <code>get_data()</code> are modified. <code>Drake</code> is R-focused, not file-focused. If you embrace this viewpoint, your work will be easier.</p>

<h2>R Markdown and knitr reports</h2>

<p>For a serious project, you should use <code>drake</code>&#39;s <code>make()</code> function outside <code>knitr</code>. In other words, you should treat R Markdown reports and other <code>knitr</code> documents as targets and imports, not as a way to run <code>make()</code>. Viewed as targets, <code>drake</code> makes special exceptions for R Markdown reports and other <a href="https://github.com/yihui/knitr">knitr</a> reports such as <code>*.Rmd</code> and <code>*.Rnw</code> files. Not every <code>drake</code> project needs them, but it is good practice to use them to summarize the final results of a project once all the other targets have already been built. The basic example, for instance, has an R Markdown report. <code>report.Rmd</code> is knitted to build <code>report.md</code>, which summarizes the final results.</p>

<pre><code class="r"># Load all the functions and the workflow plan data frame, my_plan.
load_basic_example() # Get the code with drake_example(&quot;basic&quot;).
</code></pre>

<p>To see where <code>report.md</code> will be built, look to the right of the dependency graph.</p>

<pre><code class="r">config &lt;- drake_config(my_plan)
vis_drake_graph(config)
</code></pre>

<p><iframe
src = "https://ropensci.github.io/drake/images/outdated.html"
width = "100%" height = "600px" allowtransparency="true"
style="border: none; box-shadow: none">
</iframe></p>

<p><code>Drake</code> treats <a href="https://github.com/yihui/knitr">knitr</a> report as a special cases. Whenever <code>drake</code> sees <code>knit()</code> or <code>render()</code> (<a href="https://github.com/rstudio/rmarkdown">rmarkdown</a>) mentioned in a command, it dives into the source file to look for dependencies. Consider <code>report.Rmd</code>, which you can view <a href="https://github.com/ropensci/drake/blob/master/inst/examples/basic/report.Rmd">here</a>. When <code>drake</code> sees <code>readd(small)</code> in an active code chunk, it knows <a href="https://github.com/ropensci/drake/blob/master/inst/examples/basic/report.Rmd">report.Rmd</a> depends on the target called <code>small</code>, and it draws the appropriate arrow in the dependency graph above. And if <code>small</code> ever changes, <code>make(my_plan)</code> will re-process <a href="https://github.com/ropensci/drake/blob/master/inst/examples/basic/report.Rmd">report.Rmd</a> to produce the target file <code>report.md</code>.</p>

<p><a href="https://github.com/yihui/knitr">knitr</a> reports are the only kind of file that <code>drake</code> analyzes for dependencies. It does not give R scripts the same special treatment.</p>

<h2>Workflows as R packages</h2>

<p>The R package structure is a great way to organize the files of your project. Writing your own package to contain your data science workflow is a good idea, but you will need to</p>

<ol>
<li>Use <code>expose_imports()</code> to properly account for all your nested function dependencies, and</li>
<li>If you load the package with <code>devtools::load_all()</code>, set the <code>prework</code> argument of <code>make()</code>: e.g. <code>make(prework = &quot;devtools::load_all()&quot;)</code>.</li>
</ol>

<p>Thanks to <a href="https://github.com/dapperjapper">Jasper Clarkberg</a> for the workaround behind <code>expose_imports()</code>.</p>

<h3>Advantages of putting workflows in R packages</h3>

<ul>
<li>The file organization of R packages is a well-understood community standard. If you follow it, your work may be more readable and thus reproducible.</li>
<li>R package installation is a standard process. The system makes it easier for others to obtain and run your code.</li>
<li>You get development and quality control tools for free: <a href="https://github.com/hadley/devtools">helpers for loading code and creating files</a>, <a href="http://r-pkgs.had.co.nz/tests.html">unit testing</a>, <a href="http://r-pkgs.had.co.nz/check.html">package checks</a>, <a href="https://github.com/r-lib/covr">code coverage</a>, and <a href="https://ipub.com/continuous-integration-for-r/">continuous integration</a>.</li>
</ul>

<h3>The problem</h3>

<p>For <code>drake</code>, there is one problem: nested functions. <code>Drake</code> always looks for imported functions nested in other imported functions, but only in your environment. When it sees a function from a package, it does not look in its body for other imports.</p>

<p>To see this, consider the <code>digest()</code> function from the <a href="https://github.com/eddelbuettel/digest"><code>digest</code> package</a>. <a href="https://github.com/eddelbuettel/digest"><code>Digest</code> package</a> is a utility for computing hashes, not a data science workflow, but I will use it to demonstrate how <code>drake</code> treats imports from packages.</p>

<pre><code class="r">library(digest)
g &lt;- function(x){
  digest(x)
}
f &lt;- function(x){
  g(x)
}
plan &lt;- drake_plan(x = f(1))

# Here are the reproducibly tracked objects in the workflow.
tracked(plan)
## [1] &quot;g&quot;      &quot;digest&quot; &quot;f&quot;      &quot;x&quot;

# But the `digest()` function has dependencies too.
# Because `drake` knows `digest()` is from a package,
# it ignores these dependencies by default.
head(deps(digest), 10)
##  [1] &quot;.Call&quot;           &quot;.errorhandler&quot;   &quot;any&quot;            
##  [4] &quot;as.integer&quot;      &quot;as.raw&quot;          &quot;base::serialize&quot;
##  [7] &quot;digest_impl&quot;     &quot;file.access&quot;     &quot;file.exists&quot;    
## [10] &quot;file.info&quot;
</code></pre>

<h3>The solution</h3>

<p>To force <code>drake</code> to dive deeper into the nested functions in a package, you must use <code>expose_imports()</code>. Again, I demonstrate with the <a href="https://github.com/eddelbuettel/digest"><code>digest</code> package</a> package, but you should really only do this with a package you write yourself to contain your workflow. For external packages, <a href="https://rstudio.github.io/packrat/">packrat</a> is a much better solution for package reproducibility.</p>

<pre><code class="r">expose_imports(digest)
## &lt;environment: R_GlobalEnv&gt;
new_objects &lt;- tracked(plan)
head(new_objects, 10)
##  [1] &quot;digest&quot;          &quot;warning&quot;         &quot;as.raw&quot;         
##  [4] &quot;.Call&quot;           &quot;.errorhandler&quot;   &quot;any&quot;            
##  [7] &quot;as.integer&quot;      &quot;base::serialize&quot; &quot;digest_impl&quot;    
## [10] &quot;file.access&quot;
length(new_objects)
## [1] 32

# Now when you call `make()`, `drake` will dive into `digest`
# to import dependencies.

cache &lt;- storr::storr_environment() # just for examples
make(plan, cache = cache)
## target x
head(cached(cache = cache), 10)
##  [1] &quot;any&quot;             &quot;as.integer&quot;      &quot;as.raw&quot;         
##  [4] &quot;base::serialize&quot; &quot;digest&quot;          &quot;digest_impl&quot;    
##  [7] &quot;f&quot;               &quot;file.access&quot;     &quot;file.exists&quot;    
## [10] &quot;file.info&quot;
length(cached(cache = cache))
## [1] 30
</code></pre>

<pre><code>## [1] TRUE
</code></pre>

<h1>Generating workflow plan data frames</h1>

<p><code>Drake</code> has the following functions to generate workflow plan data frames (the <code>plan</code> argument of <code>make()</code>, where you list your targets and commands). </p>

<ul>
<li><code>drake_plan()</code></li>
<li><code>evaluate_plan()</code></li>
<li><code>expand_plan()</code></li>
<li><code>gather_plan()</code></li>
<li><code>reduce_plan()</code></li>
<li><code>plan_analyses()</code></li>
<li><code>plan_summaries()</code></li>
</ul>

<p>Except for <code>drake_plan()</code>, they all use wildcards as templates. For example, suppose your workflow checks several metrics of several schools. The idea is to write a workflow plan with your metrics and let the wildcard templating expand over the available schools.</p>

<pre><code class="r">hard_plan &lt;- drake_plan(
  credits = check_credit_hours(school__),
  students = check_students(school__),
  grads = check_graduations(school__),
  public_funds = check_public_funding(school__)
)

evaluate_plan(
  hard_plan,
  rules = list(school__ = c(&quot;schoolA&quot;, &quot;schoolB&quot;, &quot;schoolC&quot;))
)
## # A tibble: 12 x 2
##    target               command                      
##    &lt;chr&gt;                &lt;chr&gt;                        
##  1 credits_schoolA      check_credit_hours(schoolA)  
##  2 credits_schoolB      check_credit_hours(schoolB)  
##  3 credits_schoolC      check_credit_hours(schoolC)  
##  4 students_schoolA     check_students(schoolA)      
##  5 students_schoolB     check_students(schoolB)      
##  6 students_schoolC     check_students(schoolC)      
##  7 grads_schoolA        check_graduations(schoolA)   
##  8 grads_schoolB        check_graduations(schoolB)   
##  9 grads_schoolC        check_graduations(schoolC)   
## 10 public_funds_schoolA check_public_funding(schoolA)
## 11 public_funds_schoolB check_public_funding(schoolB)
## 12 public_funds_schoolC check_public_funding(schoolC)
</code></pre>

<p>But what if some metrics do not make sense? For example, what if <code>schoolC</code> is a completely privately-funded school? With no public funds, <code>check_public_funds(schoolC)</code> may quit in error if we are not careful. This is where setting up workflow plans gets tricky. You may need to use multiple wildcards and make some combinations of values are left out.</p>

<pre><code class="r">library(magrittr)
rules_grid &lt;- tibble::tibble(
  school_ =  c(&quot;schoolA&quot;, &quot;schoolB&quot;, &quot;schoolC&quot;),
  funding_ = c(&quot;public&quot;, &quot;public&quot;, &quot;private&quot;),
) %&gt;%
  tidyr::crossing(cohort_ = c(&quot;2012&quot;, &quot;2013&quot;, &quot;2014&quot;, &quot;2015&quot;)) %&gt;%
  dplyr::filter(!(school_ == &quot;schoolB&quot; &amp; cohort_ %in% c(&quot;2012&quot;, &quot;2013&quot;))) %&gt;%
  print()
## # A tibble: 10 x 3
##    school_ funding_ cohort_
##    &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt;  
##  1 schoolA public   2012   
##  2 schoolA public   2013   
##  3 schoolA public   2014   
##  4 schoolA public   2015   
##  5 schoolB public   2014   
##  6 schoolB public   2015   
##  7 schoolC private  2012   
##  8 schoolC private  2013   
##  9 schoolC private  2014   
## 10 schoolC private  2015
</code></pre>

<p>Then, alternately choose <code>expand = TRUE</code> and <code>expand = FALSE</code> when evaluating the wildcards.</p>

<pre><code class="r">drake_plan(
  credits = check_credit_hours(&quot;school_&quot;, &quot;funding_&quot;, &quot;cohort_&quot;),
  students = check_students(&quot;school_&quot;, &quot;funding_&quot;, &quot;cohort_&quot;),
  grads = check_graduations(&quot;school_&quot;, &quot;funding_&quot;, &quot;cohort_&quot;),
  public_funds = check_public_funding(&quot;school_&quot;, &quot;funding_&quot;, &quot;cohort_&quot;),
  strings_in_dots = &quot;literals&quot;
) %&gt;% evaluate_plan(
    wildcard = &quot;school_&quot;,
    values = rules_grid$school_,
    expand = TRUE
  ) %&gt;%
  evaluate_plan(
    wildcard = &quot;funding_&quot;,
    rules = rules_grid,
    expand = FALSE
  ) %&gt;%
  DT::datatable()
## Error in loadNamespace(name): there is no package called &#39;webshot&#39;
</code></pre>

<p>Thanks to <a href="https://github.com/AlexAxthelm">Alex Axthelm</a> for this example in <a href="https://github.com/ropensci/drake/issues/235">issue 235</a>.</p>

<h1>Remote data sources</h1>

<p>Some workflows rely on remote data from the internet, and the workflow needs to refresh when the datasets change. As an example, let us consider the download logs of <a href="https://cran.r-project.org/">CRAN packages</a>.</p>

<pre><code class="r">library(drake)
library(R.utils) # For unzipping the files we download.
library(curl)    # For downloading data.
library(httr)    # For querying websites.

url &lt;- &quot;http://cran-logs.rstudio.com/2018/2018-02-09-r.csv.gz&quot;
</code></pre>

<p>How do we know when the data at the URL changed? We get the time that the file was last modified. (Alternatively, we could use an HTTP ETag.)</p>

<pre><code class="r">query &lt;- HEAD(url)
timestamp &lt;- query$headers[[&quot;last-modified&quot;]]
timestamp
## [1] &quot;Mon, 12 Feb 2018 16:34:48 GMT&quot;
</code></pre>

<p>In our workflow plan, the timestamp is a target and a dependency. When the timestamp changes, so does everything downstream.</p>

<pre><code class="r">cranlogs_plan &lt;- drake_plan(
  timestamp = HEAD(url)$headers[[&quot;last-modified&quot;]],
  logs = get_logs(url, timestamp),
  strings_in_dots = &quot;literals&quot;
)
cranlogs_plan
## # A tibble: 2 x 2
##   target    command                                 
##   &lt;chr&gt;     &lt;chr&gt;                                   
## 1 timestamp &quot;HEAD(url)$headers[[\&quot;last-modified\&quot;]]&quot;
## 2 logs      get_logs(url, timestamp)
</code></pre>

<p>To make sure we always have the latest timestamp, we use the <code>&quot;always&quot;</code> trigger. (See <a href="https://github.com/ropensci/drake/blob/master/vignettes/debug.Rmd#test-with-triggers">this section of the debugging vignette</a> for more on triggers.)</p>

<pre><code class="r">cranlogs_plan$trigger &lt;- c(&quot;always&quot;, &quot;any&quot;)
cranlogs_plan
## # A tibble: 2 x 3
##   target    command                                  trigger
##   &lt;chr&gt;     &lt;chr&gt;                                    &lt;chr&gt;  
## 1 timestamp &quot;HEAD(url)$headers[[\&quot;last-modified\&quot;]]&quot; always 
## 2 logs      get_logs(url, timestamp)                 any
</code></pre>

<p>Lastly, we define the <code>get_logs()</code> function, which actually downloads the data.</p>

<pre><code class="r"># The ... is just so we can write dependencies as function arguments
# in the workflow plan.
get_logs &lt;- function(url, ...){
  curl_download(url, &quot;logs.csv.gz&quot;)       # Get a big file.
  gunzip(&quot;logs.csv.gz&quot;, overwrite = TRUE) # Unzip it.
  out &lt;- read.csv(&quot;logs.csv&quot;, nrows = 4)  # Extract the data you need.
  unlink(c(&quot;logs.csv.gz&quot;, &quot;logs.csv&quot;))    # Remove the big files
  out                                     # Value of the target.
}
</code></pre>

<p>When we are ready, we run the workflow.</p>

<pre><code class="r">make(cranlogs_plan)
## Unloading targets from environment:
##   timestamp
## target timestamp: trigger &quot;always&quot;
## target logs
## Used non-default triggers. Some targets may not be up to date.

readd(logs)
##         date     time     size version  os country ip_id
## 1 2018-02-09 13:01:13 82375220   3.4.3 win      RO     1
## 2 2018-02-09 13:02:06 74286541   3.3.3 win      US     2
## 3 2018-02-09 13:02:10 82375216   3.4.3 win      US     3
## 4 2018-02-09 13:03:30 82375220   3.4.3 win      IS     4
</code></pre>

</body>

</html>
